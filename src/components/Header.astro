---
import Container from "./Container.astro";
import { SITE } from "@/config/site";

const pathname = Astro.url.pathname;
const isEn = pathname === "/en" || pathname.startsWith("/en/");
const normalizedPath = pathname === "/" ? "" : pathname.replace(/\/$/, "");

// Explicit NL/EN mapping for key routes (Dutch slugs at root, English slugs under /en).
const enFromNl = new Map([
  ["/", "/en/"],
  ["/missie", "/en/mission"],
  ["/over-ons", "/en/about"],
  ["/organisatie", "/en/organization"],
  ["/stvg", "/en/about"],
  ["/speerpunten", "/en/topics"],
  ["/oprichting", "/en/founding"],
  ["/thema", "/en/topics"],
  ["/thema/gay-rechten", "/en/topics/gay-rights"],
  ["/thema/mensenrechten", "/en/topics/human-rights"],
  ["/transparantie", "/en/transparency"],
  ["/doneren", "/en/donate"],
  ["/contact", "/en/contact"],
  ["/resources", "/en/resources"],
  ["/resources/2026-gay-rights", "/en/resources/2026-gay-rights"],
  ["/blog", "/en/blog"],
]);

const nlFromEn = new Map([
  ["/en", "/"],
  ["/en/", "/"],
  ["/en/mission", "/missie"],
  ["/en/about", "/over-ons"],
  ["/en/organization", "/organisatie"],
  ["/en/founding", "/oprichting"],
  ["/en/topics", "/thema"],
  ["/en/topics/gay-rights", "/thema/gay-rechten"],
  ["/en/topics/human-rights", "/thema/mensenrechten"],
  ["/en/transparency", "/transparantie"],
  ["/en/donate", "/doneren"],
  ["/en/contact", "/contact"],
  ["/en/resources", "/resources"],
  ["/en/resources/2026-gay-rights", "/resources/2026-gay-rights"],
  ["/en/blog", "/blog"],
]);

const mapToEn = (p: string) => {
  const base = p === "" ? "/" : p;
  return enFromNl.get(base) ?? `/en${base}`;
};

const mapToNl = (p: string) => {
  const base = p.startsWith("/en") ? p.replace(/^\/en/, "") || "/" : p;
  if (base === "") return "/";
  return nlFromEn.get(p) ?? base;
};

const enHref = isEn ? pathname : mapToEn(normalizedPath || "/");
const nlHref = isEn ? mapToNl(normalizedPath || "/en/") : pathname;

const normalizeForRoute = (p: string) =>
  p === "/" ? "/" : p.replace(/\/$/, "");
const currentPath = normalizeForRoute(pathname);

const brand = {
  label: SITE.displayUrl ?? SITE.shortName,
  href: isEn ? "/en/" : "/",
};

const nav = [
  {
    hrefEn: "/en/mission",
    hrefNl: "/missie",
    labelEn: "Mission",
    labelNl: "Missie",
  },
  {
    hrefEn: "/en/about",
    hrefNl: "/over-ons",
    labelEn: "About",
    labelNl: "Over ons",
  },
  {
    hrefEn: "/en/organization",
    hrefNl: "/organisatie",
    labelEn: "Organization",
    labelNl: "Organisatie",
  },
  {
    hrefEn: "/en/topics",
    hrefNl: "/thema",
    labelEn: "Topics",
    labelNl: "Themaâ€™s",
  },
  {
    hrefEn: "/en/founding",
    hrefNl: "/oprichting",
    labelEn: "Founding",
    labelNl: "Oprichting",
  },
  {
    hrefEn: "/en/transparency",
    hrefNl: "/transparantie",
    labelEn: "Transparency",
    labelNl: "Transparantie",
  },
  {
    hrefEn: "/en/blog",
    hrefNl: "/blog",
    labelEn: "Blog",
    labelNl: "Blog",
  },
  {
    hrefEn: "/en/donate",
    hrefNl: "/doneren",
    labelEn: "Support",
    labelNl: "Steun",
  },
].map((item) => ({
  href: isEn ? item.hrefEn : item.hrefNl,
  label: isEn ? item.labelEn : item.labelNl,
}));

const isActive = (href: string) => {
  const target = normalizeForRoute(href);
  if (target === "/") return currentPath === "/";
  return currentPath === target || currentPath.startsWith(target + "/");
};
---

<header class="site-header" role="banner">
  <Container>
    <div class="top">
      <a class="sr-only" href={brand.href}>Go to homepage</a>

      <a
        class={`brand-link ${isActive(brand.href) ? "is-active" : ""}`}
        href={brand.href}
        aria-current={isActive(brand.href) ? "page" : undefined}
      >
        {brand.label}
      </a>

      <div class="actions">
        <button
          type="button"
          class="menu-toggle"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          Menu
        </button>
      </div>
    </div>

    <div class="nav-row">
      <nav class="nav" aria-label="Primary navigation">
        <a
          class={`nav-link nav-brandlink ${isActive(brand.href) ? "is-active" : ""}`}
          href={brand.href}
          aria-current={isActive(brand.href) ? "page" : undefined}
        >
          {brand.label}
        </a>

        {
          nav.map((item) => (
            <a
              class={`nav-link ${isActive(item.href) ? "is-active" : ""}`}
              href={item.href}
              aria-current={isActive(item.href) ? "page" : undefined}
            >
              {item.label}
            </a>
          ))
        }

        <div class="lang-switch" aria-label="Language switch">
          <a
            class={`lang-link ${isEn ? "is-active" : ""}`}
            href={enHref}
            hreflang="en"
            aria-current={isEn ? "page" : undefined}
          >
            <span class="lang-flag-wrap" aria-hidden="true">
              <img
                class="lang-flag"
                src="/pictures/united-states-flag.webp"
                alt=""
                loading="lazy"
                width="38"
                height="20"
              />
            </span>
            <span class="sr-only">English</span>
          </a>
          <a
            class={`lang-link ${!isEn ? "is-active" : ""}`}
            href={nlHref}
            hreflang="nl"
            aria-current={!isEn ? "page" : undefined}
          >
            <span class="lang-flag-wrap" aria-hidden="true">
              <img
                class="lang-flag"
                src="/pictures/dutch-flag.webp"
                alt=""
                loading="lazy"
                width="38"
                height="20"
              />
            </span>
            <span class="sr-only">Nederlands</span>
          </a>
        </div>
      </nav>
    </div>
  </Container>

  <div id="mobile-menu" class="mobile" hidden>
    <Container>
      <nav class="mobile-nav" aria-label="Mobile navigation">
        {
          nav.map((item) => (
            <a
              class={`mobile-link ${isActive(item.href) ? "is-active" : ""}`}
              href={item.href}
              aria-current={isActive(item.href) ? "page" : undefined}
            >
              {item.label}
            </a>
          ))
        }
        <div class="mobile-lang" aria-label="Language switch">
          <a
            class={`mobile-link ${isEn ? "is-active" : ""}`}
            href={enHref}
            hreflang="en"
            aria-current={isEn ? "page" : undefined}
          >
            <span
              style="display:inline-flex; align-items:center; gap:10px; justify-content:center;"
            >
              <span class="lang-flag-wrap" aria-hidden="true">
                <img
                  class="lang-flag"
                  src="/pictures/united-states-flag.webp"
                  alt=""
                  loading="lazy"
                  width="38"
                  height="20"
                />
              </span>
              <span>English</span>
            </span>
          </a>
          <a
            class={`mobile-link ${!isEn ? "is-active" : ""}`}
            href={nlHref}
            hreflang="nl"
            aria-current={!isEn ? "page" : undefined}
          >
            <span
              style="display:inline-flex; align-items:center; gap:10px; justify-content:center;"
            >
              <span class="lang-flag-wrap" aria-hidden="true">
                <img
                  class="lang-flag"
                  src="/pictures/dutch-flag.webp"
                  alt=""
                  loading="lazy"
                  width="38"
                  height="20"
                />
              </span>
              <span>Nederlands</span>
            </span>
          </a>
        </div>
      </nav>
    </Container>
  </div>

  <script is:inline>
    (() => {
      const toggle = document.querySelector(".menu-toggle");
      const menu = document.getElementById("mobile-menu");
      if (!toggle || !menu) return;
      toggle.addEventListener("click", () => {
        const open = toggle.getAttribute("aria-expanded") === "true";
        toggle.setAttribute("aria-expanded", String(!open));
        menu.hidden = open;
      });
    })();
  </script>
</header>

<style>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 50;
    isolation: isolate;
    background: var(--header-bg);
    border-bottom: 0;
  }

  .site-header::before {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0.14;
    mix-blend-mode: screen;
    background: linear-gradient(
      110deg,
      transparent 0%,
      rgba(255, 255, 255, 0.22) 22%,
      transparent 48%
    );
    background-size: 220% 100%;
    animation: header-shimmer 12s linear infinite;
  }

  .site-header::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: var(--border-w);
    background: rgba(255, 255, 255, 0.18);
    pointer-events: none;
  }

  .top {
    padding: 0.75rem 0 0.35rem;
    display: flex;
    position: relative;
    justify-content: flex-end;
    align-items: center;
  }

  .brand-link {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    text-decoration: none;
    color: rgba(255, 255, 255, 0.96);
    font-weight: 900;
    letter-spacing: -0.02em;
    line-height: 1;
  }

  .brand-link.is-active {
    color: rgba(255, 255, 255, 0.98);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .nav-row {
    padding: 0.25rem 0 0.8rem;
    display: flex;
    justify-content: center;
  }

  .nav {
    display: none;
    gap: 1.25rem;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
  }

  .nav-brandlink {
    font-weight: 900;
    letter-spacing: -0.02em;
  }

  .nav-link {
    text-decoration: none;
    color: rgba(255, 255, 255, 0.92);
    font-weight: 650;
    padding: 0.45rem 0.65rem;
    border-radius: 10px;
    border: var(--border-w) solid transparent;
    background: transparent;
  }

  .nav-link.is-active {
    background: transparent;
    color: #facc15;
    border-color: transparent;
  }

  .nav-link:hover {
    background: transparent;
    color: #facc15;
    border-color: transparent;
  }

  .lang-switch {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 0.5rem;
    padding: 2px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.22);
    background: rgba(0, 0, 0, 0.18);
  }

  .lang-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.82);
    font-weight: 700;
    font-size: 0.9rem;
    padding: 0.35rem 0.4rem;
    border-radius: 999px;
    line-height: 1;
    border: 1px solid transparent;
  }

  .lang-link:focus-visible {
    outline: 2px solid rgba(250, 204, 21, 0.9);
    outline-offset: 2px;
  }

  .lang-link.is-active,
  .lang-link:hover {
    color: #facc15;
  }

  .lang-link.is-active {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.28);
  }

  .lang-flag-wrap {
    width: 30px;
    height: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    overflow: hidden;
    background: transparent;
  }

  .lang-flag {
    display: block;
    height: 18px;
    width: auto;
    max-width: 30px;
    object-fit: contain;
  }

  .lang-sep {
    color: rgba(255, 255, 255, 0.35);
    font-weight: 700;
  }

  .actions {
    justify-self: end;
    display: flex;
    gap: 0.6rem;
    align-items: center;
  }

  .menu-toggle {
    background: transparent;
    border: var(--border-w) solid rgba(255, 255, 255, 0.5);
    color: rgba(255, 255, 255, 0.94);
    padding: 0.5rem 0.75rem;
    border-radius: 999px;
    font-weight: 650;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  .menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .mobile {
    position: relative;
    border-top: 0;
    background: var(--header-bg);
  }

  .mobile::after {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0.14;
    mix-blend-mode: screen;
    background: linear-gradient(
      110deg,
      transparent 0%,
      rgba(255, 255, 255, 0.22) 22%,
      transparent 48%
    );
    background-size: 220% 100%;
    animation: header-shimmer 12s linear infinite;
  }

  .mobile::before {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    height: var(--border-w);
    background: rgba(255, 255, 255, 0.18);
    pointer-events: none;
  }

  .mobile-nav {
    padding: 0.75rem 0 1rem;
    display: grid;
    gap: 0.5rem;
    justify-items: center;
  }

  .mobile-lang {
    width: min(420px, 100%);
    display: grid;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .mobile-link {
    display: block;
    padding: 0.75rem 0.75rem;
    border-radius: 0.75rem;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.94);
    background: rgba(255, 255, 255, 0.06);
    border: var(--border-w) solid rgba(255, 255, 255, 0.18);
    font-weight: 650;
    text-align: center;
    width: min(420px, 100%);
  }

  .mobile-link.is-active {
    background: rgba(255, 255, 255, 0.06);
    color: #facc15;
  }

  .mobile-link:hover {
    color: #facc15;
    border-color: rgba(255, 255, 255, 0.18);
  }

  @media (min-width: 860px) {
    .nav {
      display: flex;
    }

    .brand-link {
      display: none;
    }

    .menu-toggle {
      display: none;
    }

    .mobile {
      display: none;
    }

    .nav-brandlink {
      display: inline-flex;
    }

    .brand-logo {
      width: 58px;
      height: 58px;
      border-radius: 16px;
    }

    .brand-text {
      font-size: 1.15rem;
    }
  }

  @media (max-width: 859px) {
    .nav-brandlink {
      display: none;
    }
  }

  @keyframes header-shimmer {
    0% {
      background-position: -120% 0;
    }
    100% {
      background-position: 120% 0;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .site-header::before,
    .mobile::after {
      animation: none;
      opacity: 0;
    }
  }
</style>
