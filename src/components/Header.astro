---
import Container from "./Container.astro";
import { SITE } from "@/config/site";

const pathname = Astro.url.pathname;
const isEn = pathname === "/en" || pathname.startsWith("/en/");
const normalizedPath = pathname === "/" ? "" : pathname.replace(/\/$/, "");

// Explicit NL/EN mapping for key routes (Dutch slugs at root, English slugs under /en).
const enFromNl = new Map([
  ["/", "/en/"],
  ["/missie", "/en/mission"],
  ["/over-ons", "/en/about"],
  ["/organisatie", "/en/organization"],
  ["/stvg", "/en/about"],
  ["/speerpunten", "/en/topics"],
  ["/oprichting", "/en/founding"],
  ["/thema", "/en/topics"],
  ["/thema/gay-rechten", "/en/topics/gay-rights"],
  ["/thema/mensenrechten", "/en/topics/human-rights"],
  ["/transparantie", "/en/transparency"],
  ["/doneren", "/en/donate"],
  ["/contact", "/en/contact"],
  ["/resources", "/en/resources"],
  ["/resources/2026-gay-rights", "/en/resources/2026-gay-rights"],
  ["/blog", "/en/blog"],
]);

const nlFromEn = new Map([
  ["/en", "/"],
  ["/en/", "/"],
  ["/en/mission", "/missie"],
  ["/en/about", "/over-ons"],
  ["/en/organization", "/organisatie"],
  ["/en/founding", "/oprichting"],
  ["/en/topics", "/thema"],
  ["/en/topics/gay-rights", "/thema/gay-rechten"],
  ["/en/topics/human-rights", "/thema/mensenrechten"],
  ["/en/transparency", "/transparantie"],
  ["/en/donate", "/doneren"],
  ["/en/contact", "/contact"],
  ["/en/resources", "/resources"],
  ["/en/resources/2026-gay-rights", "/resources/2026-gay-rights"],
  ["/en/blog", "/blog"],
]);

const mapToEn = (p: string) => {
  const base = p === "" ? "/" : p;
  return enFromNl.get(base) ?? `/en${base}`;
};

const mapToNl = (p: string) => {
  const base = p.startsWith("/en") ? p.replace(/^\/en/, "") || "/" : p;
  if (base === "") return "/";
  return nlFromEn.get(p) ?? base;
};

const enHref = isEn ? pathname : mapToEn(normalizedPath || "/");
const nlHref = isEn ? mapToNl(normalizedPath || "/en/") : pathname;

const normalizeForRoute = (p: string) =>
  p === "/" ? "/" : p.replace(/\/$/, "");
const currentPath = normalizeForRoute(pathname);

const brand = {
  label: SITE.displayUrl ?? SITE.shortName,
  href: isEn ? "/en/" : "/",
};

const nav = [
  {
    labelEn: "About",
    labelNl: "Over ons",
    isGroup: true,
    submenu: [
      {
        hrefEn: "/en/about",
        hrefNl: "/over-ons",
        labelEn: "Intro",
        labelNl: "Intro",
      },
      {
        hrefEn: "/en/mission",
        hrefNl: "/missie",
        labelEn: "Our Mission",
        labelNl: "Onze missie",
      },
      {
        hrefEn: "/en/organization",
        hrefNl: "/organisatie",
        labelEn: "Organization & Board",
        labelNl: "Organisatie & Bestuur",
      },
      {
        hrefEn: "/en/transparency",
        hrefNl: "/transparantie",
        labelEn: "Transparency & Governance",
        labelNl: "Transparantie & governance",
      },
    ],
  },
  {
    labelEn: "Knowledge",
    labelNl: "Kennis",
    isGroup: true,
    submenu: [
      {
        hrefEn: "/en/topics",
        hrefNl: "/thema",
        labelEn: "Topics",
        labelNl: "Thema's",
      },
      {
        hrefEn: "/en/guides",
        hrefNl: "/gids",
        labelEn: "Legal Guides",
        labelNl: "Juridische gidsen",
      },
      {
        hrefEn: "/en/blog",
        hrefNl: "/blog",
        labelEn: "Blog & Articles",
        labelNl: "Blog & artikelen",
      },
    ],
  },
  {
    labelEn: "Projects",
    labelNl: "Projecten",
    isGroup: true,
    submenu: [
      {
        hrefEn: "/en/projects",
        hrefNl: "/projecten",
        labelEn: "Initiatives",
        labelNl: "Initiatieven",
      },
      {
        hrefEn: "/en/projects/setup",
        hrefNl: "/projecten/opzet",
        labelEn: "Project Setup",
        labelNl: "Projectopzet",
      },
    ],
  },
  {
    labelEn: "Support",
    labelNl: "Steun",
    isGroup: true,
    submenu: [
      {
        hrefEn: "/en/support/donate",
        hrefNl: "/steun/doneren",
        labelEn: "Donate",
        labelNl: "Doneren",
      },
      {
        hrefEn: "/en/support/crowdfunding",
        hrefNl: "/steun/crowdfunding",
        labelEn: "Crowdfunding",
        labelNl: "Crowdfunding",
      },
      {
        hrefEn: "/en/support/grants-funds",
        hrefNl: "/steun/subsidies-fondsen",
        labelEn: "Grants & Funds",
        labelNl: "Subsidies & fondsen",
      },
      {
        hrefEn: "/en/support/contributions",
        hrefNl: "/steun/bijdragen-erkenning",
        labelEn: "Contributions & Recognition",
        labelNl: "Bijdragen & erkenning",
      },
      {
        hrefEn: "/en/support/kickstart",
        hrefNl: "/steun/kickstart",
        labelEn: "Kickstart",
        labelNl: "Kickstart (oprichtingsfase)",
      },
    ],
  },
  {
    hrefEn: "/en/statutes",
    hrefNl: "/statuten",
    labelEn: "Statutes",
    labelNl: "Statuten",
  },
  {
    hrefEn: "/en/contact",
    hrefNl: "/contact",
    labelEn: "Contact",
    labelNl: "Contact",
  },
].map((item: any) => ({
  label: isEn ? item.labelEn : item.labelNl,
  href: !item.isGroup ? (isEn ? item.hrefEn : item.hrefNl) : undefined,
  isGroup: item.isGroup ?? false,
  submenu:
    item.submenu?.map((sub: any) => ({
      href: isEn ? sub.hrefEn : sub.hrefNl,
      label: isEn ? sub.labelEn : sub.labelNl,
    })) ?? [],
}));

const isActive = (href: string | undefined) => {
  if (!href) return false;
  const target = normalizeForRoute(href);
  if (target === "/") return currentPath === "/";
  return currentPath === target || currentPath.startsWith(target + "/");
};

const isGroupActive = (submenu: any[] | undefined) => {
  if (!submenu) return false;
  return submenu.some((item) => isActive(item.href));
};
---

<header class="site-header" role="banner">
  <Container>
    <div class="top">
      <a class="sr-only" href={brand.href}>Go to homepage</a>

      <a
        class={`brand-link ${isActive(brand.href) ? "is-active" : ""}`}
        href={brand.href}
        aria-current={isActive(brand.href) ? "page" : undefined}
      >
        {brand.label}
      </a>

      <div class="actions">
        <button
          type="button"
          class="menu-toggle"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          Menu
        </button>
      </div>
    </div>

    <div class="nav-row">
      <nav class="nav" aria-label="Primary navigation">
        <a
          class={`nav-link nav-brandlink ${isActive(brand.href) ? "is-active" : ""}`}
          href={brand.href}
          aria-current={isActive(brand.href) ? "page" : undefined}
        >
          {brand.label}
        </a>

        {
          nav.map((item) => {
            if (item.isGroup) {
              return (
                <div
                  class={`nav-group ${isGroupActive(item.submenu) ? "is-active" : ""}`}
                >
                  <button
                    class="nav-group-trigger"
                    aria-expanded="false"
                    aria-haspopup="true"
                  >
                    {item.label}
                  </button>
                  <div class="nav-submenu">
                    {item.submenu?.map((sub) => (
                      <a
                        class={`nav-submenu-link ${isActive(sub.href) ? "is-active" : ""}`}
                        href={sub.href}
                        aria-current={isActive(sub.href) ? "page" : undefined}
                      >
                        {sub.label}
                      </a>
                    ))}
                  </div>
                </div>
              );
            } else {
              return (
                <a
                  class={`nav-link ${isActive(item.href) ? "is-active" : ""}`}
                  href={item.href}
                  aria-current={isActive(item.href) ? "page" : undefined}
                >
                  {item.label}
                </a>
              );
            }
          })
        }

        <div class="lang-switch" aria-label="Language switch">
          <a
            class={`lang-link ${isEn ? "is-active" : ""}`}
            href={enHref}
            hreflang="en"
            aria-current={isEn ? "page" : undefined}
          >
            <span class="lang-flag-wrap" aria-hidden="true">
              <img
                class="lang-flag"
                src="/pictures/united-states-flag.webp"
                alt=""
                loading="lazy"
                width="38"
                height="20"
              />
            </span>
            <span class="sr-only">English</span>
          </a>
          <a
            class={`lang-link ${!isEn ? "is-active" : ""}`}
            href={nlHref}
            hreflang="nl"
            aria-current={!isEn ? "page" : undefined}
          >
            <span class="lang-flag-wrap" aria-hidden="true">
              <img
                class="lang-flag"
                src="/pictures/dutch-flag.webp"
                alt=""
                loading="lazy"
                width="38"
                height="20"
              />
            </span>
            <span class="sr-only">Nederlands</span>
          </a>
        </div>
      </nav>
    </div>
  </Container>

  <div id="mobile-menu" class="mobile" hidden>
    <Container>
      <nav class="mobile-nav" aria-label="Mobile navigation">
        {
          nav.map((item) => {
            if (item.isGroup) {
              return (
                <div
                  class={`mobile-group ${isGroupActive(item.submenu) ? "is-active" : ""}`}
                >
                  <button
                    class="mobile-group-trigger"
                    aria-expanded="false"
                    aria-haspopup="true"
                  >
                    {item.label}
                  </button>
                  <div class="mobile-submenu">
                    {item.submenu?.map((sub) => (
                      <a
                        class={`mobile-submenu-link ${isActive(sub.href) ? "is-active" : ""}`}
                        href={sub.href}
                        aria-current={isActive(sub.href) ? "page" : undefined}
                      >
                        {sub.label}
                      </a>
                    ))}
                  </div>
                </div>
              );
            } else {
              return (
                <a
                  class={`mobile-link ${isActive(item.href) ? "is-active" : ""}`}
                  href={item.href}
                  aria-current={isActive(item.href) ? "page" : undefined}
                >
                  {item.label}
                </a>
              );
            }
          })
        }
        <div class="mobile-lang" aria-label="Language switch">
          <a
            class={`mobile-link ${isEn ? "is-active" : ""}`}
            href={enHref}
            hreflang="en"
            aria-current={isEn ? "page" : undefined}
          >
            <span
              style="display:inline-flex; align-items:center; gap:10px; justify-content:center;"
            >
              <span class="lang-flag-wrap" aria-hidden="true">
                <img
                  class="lang-flag"
                  src="/pictures/united-states-flag.webp"
                  alt=""
                  loading="lazy"
                  width="38"
                  height="20"
                />
              </span>
              <span>English</span>
            </span>
          </a>
          <a
            class={`mobile-link ${!isEn ? "is-active" : ""}`}
            href={nlHref}
            hreflang="nl"
            aria-current={!isEn ? "page" : undefined}
          >
            <span
              style="display:inline-flex; align-items:center; gap:10px; justify-content:center;"
            >
              <span class="lang-flag-wrap" aria-hidden="true">
                <img
                  class="lang-flag"
                  src="/pictures/dutch-flag.webp"
                  alt=""
                  loading="lazy"
                  width="38"
                  height="20"
                />
              </span>
              <span>Nederlands</span>
            </span>
          </a>
        </div>
      </nav>
    </Container>
  </div>

  <script is:inline>
    (() => {
      // Mobile menu toggle
      const toggle = document.querySelector(".menu-toggle");
      const menu = document.getElementById("mobile-menu");
      if (toggle && menu) {
        toggle.addEventListener("click", () => {
          const open = toggle.getAttribute("aria-expanded") === "true";
          toggle.setAttribute("aria-expanded", String(!open));
          menu.hidden = open;
        });
      }

      // Desktop dropdown groups (hover)
      const desktopGroups = document.querySelectorAll(".nav-group");
      desktopGroups.forEach((group) => {
        const trigger = group.querySelector(".nav-group-trigger");
        if (!trigger) return;

        group.addEventListener("mouseenter", () => {
          trigger.setAttribute("aria-expanded", "true");
          group.setAttribute("aria-expanded", "true");
        });

        group.addEventListener("mouseleave", () => {
          trigger.setAttribute("aria-expanded", "false");
          group.setAttribute("aria-expanded", "false");
        });
      });

      // Mobile dropdown groups (toggle on click)
      const mobileGroups = document.querySelectorAll(".mobile-group");
      mobileGroups.forEach((group) => {
        const trigger = group.querySelector(".mobile-group-trigger");
        if (!trigger) return;

        trigger.addEventListener("click", (e) => {
          e.preventDefault();
          const isOpen = trigger.getAttribute("aria-expanded") === "true";
          trigger.setAttribute("aria-expanded", String(!isOpen));
          group.setAttribute("aria-expanded", String(!isOpen));
        });
      });
    })();
  </script>
</header>

<style>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 50;
    isolation: isolate;
    background: var(--header-bg);
    border-bottom: 0;
  }

  .site-header::before {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0.14;
    mix-blend-mode: screen;
    background: linear-gradient(
      110deg,
      transparent 0%,
      rgba(255, 255, 255, 0.22) 22%,
      transparent 48%
    );
    background-size: 220% 100%;
    animation: header-shimmer 12s linear infinite;
  }

  .site-header::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: var(--border-w);
    background: rgba(255, 255, 255, 0.18);
    pointer-events: none;
  }

  .top {
    padding: 0.75rem 0 0.35rem;
    display: flex;
    position: relative;
    justify-content: flex-end;
    align-items: center;
  }

  .brand-link {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    text-decoration: none;
    color: rgba(255, 255, 255, 0.96);
    font-weight: 900;
    letter-spacing: -0.02em;
    line-height: 1;
  }

  .brand-link.is-active {
    color: rgba(255, 255, 255, 0.98);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .nav-row {
    padding: 0.25rem 0 0.8rem;
    display: flex;
    justify-content: center;
  }

  .nav {
    display: none;
    gap: 1.25rem;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    width: 100%;
  }

  .nav-brandlink {
    font-weight: 900;
    letter-spacing: -0.02em;
  }

  .nav-link {
    text-decoration: none;
    color: rgba(255, 255, 255, 0.92);
    font-weight: 650;
    padding: 0.45rem 0.65rem;
    border-radius: 10px;
    border: var(--border-w) solid transparent;
    background: transparent;
  }

  .nav-link.is-active {
    background: transparent;
    color: #facc15;
    border-color: transparent;
  }

  .nav-link:hover {
    background: transparent;
    color: #facc15;
    border-color: transparent;
  }

  .nav-group {
    position: relative;
    display: inline-flex;
    flex-direction: column;
    align-items: center;
  }

  .nav-group-trigger {
    text-decoration: none;
    color: rgba(255, 255, 255, 0.92);
    font-weight: 650;
    padding: 0.45rem 0.65rem;
    border-radius: 10px;
    border: var(--border-w) solid transparent;
    background: transparent;
    cursor: pointer;
    font-size: 1rem;
    font-family: inherit;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .nav-group-trigger::after {
    content: "▼";
    font-size: 0.7rem;
    transition: transform 200ms ease;
  }

  .nav-group-trigger[aria-expanded="true"]::after {
    transform: rotateX(180deg);
  }

  .nav-group-trigger:hover {
    color: #facc15;
  }

  .nav-group.is-active .nav-group-trigger {
    color: #facc15;
  }

  .nav-submenu {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    flex-direction: column;
    gap: 0;
    background: rgba(0, 0, 0, 0.85);
    border: 1px solid rgba(255, 255, 255, 0.18);
    border-radius: 10px;
    padding: 0.5rem 0;
    min-width: 220px;
    z-index: 100;
    margin-top: 0.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  }

  .nav-group[aria-expanded="true"] .nav-submenu,
  .nav-group:hover .nav-submenu {
    display: flex;
  }

  .nav-submenu-link {
    padding: 0.6rem 1rem;
    color: rgba(255, 255, 255, 0.92);
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95rem;
    white-space: nowrap;
    border-left: 3px solid transparent;
    transition: all 150ms ease;
  }

  .nav-submenu-link:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #facc15;
    border-left-color: #facc15;
  }

  .nav-submenu-link.is-active {
    background: rgba(255, 255, 255, 0.1);
    color: #facc15;
    border-left-color: #facc15;
  }

  .lang-switch {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 0.5rem;
    padding: 2px;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.22);
    background: rgba(0, 0, 0, 0.18);
  }

  .lang-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.82);
    font-weight: 700;
    font-size: 0.9rem;
    padding: 0.35rem 0.4rem;
    border-radius: 999px;
    line-height: 1;
    border: 1px solid transparent;
  }

  .lang-link:focus-visible {
    outline: 2px solid rgba(250, 204, 21, 0.9);
    outline-offset: 2px;
  }

  .lang-link.is-active,
  .lang-link:hover {
    color: #facc15;
  }

  .lang-link.is-active {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.28);
  }

  .lang-flag-wrap {
    width: 30px;
    height: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    overflow: hidden;
    background: transparent;
  }

  .lang-flag {
    display: block;
    height: 18px;
    width: auto;
    max-width: 30px;
    object-fit: contain;
  }

  .lang-sep {
    color: rgba(255, 255, 255, 0.35);
    font-weight: 700;
  }

  .actions {
    justify-self: end;
    display: flex;
    gap: 0.6rem;
    align-items: center;
  }

  .menu-toggle {
    background: transparent;
    border: var(--border-w) solid rgba(255, 255, 255, 0.5);
    color: rgba(255, 255, 255, 0.94);
    padding: 0.5rem 0.75rem;
    border-radius: 999px;
    font-weight: 650;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  .menu-toggle:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .mobile {
    position: relative;
    border-top: 0;
    background: var(--header-bg);
  }

  .mobile::after {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0.14;
    mix-blend-mode: screen;
    background: linear-gradient(
      110deg,
      transparent 0%,
      rgba(255, 255, 255, 0.22) 22%,
      transparent 48%
    );
    background-size: 220% 100%;
    animation: header-shimmer 12s linear infinite;
  }

  .mobile::before {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    height: var(--border-w);
    background: rgba(255, 255, 255, 0.18);
    pointer-events: none;
  }

  .mobile-nav {
    padding: 0.75rem 0 1rem;
    display: grid;
    gap: 0.5rem;
    justify-items: center;
  }

  .mobile-lang {
    width: min(420px, 100%);
    display: grid;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .mobile-link {
    display: block;
    padding: 0.75rem 0.75rem;
    border-radius: 0.75rem;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.94);
    background: rgba(255, 255, 255, 0.06);
    border: var(--border-w) solid rgba(255, 255, 255, 0.18);
    font-weight: 650;
    text-align: center;
    width: min(420px, 100%);
  }

  .mobile-link.is-active {
    background: rgba(255, 255, 255, 0.06);
    color: #facc15;
  }

  .mobile-link:hover {
    color: #facc15;
    border-color: rgba(255, 255, 255, 0.18);
  }

  .mobile-group {
    width: min(420px, 100%);
    display: grid;
    gap: 0.5rem;
  }

  .mobile-group-trigger {
    display: block;
    padding: 0.75rem 0.75rem;
    border-radius: 0.75rem;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.94);
    background: rgba(255, 255, 255, 0.06);
    border: var(--border-w) solid rgba(255, 255, 255, 0.18);
    font-weight: 650;
    text-align: center;
    width: 100%;
    cursor: pointer;
    font-size: 1rem;
    font-family: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
  }

  .mobile-group-trigger::after {
    content: "▼";
    font-size: 0.7rem;
    transition: transform 200ms ease;
  }

  .mobile-group-trigger[aria-expanded="true"]::after {
    transform: rotateX(180deg);
  }

  .mobile-group-trigger:hover {
    color: #facc15;
  }

  .mobile-group.is-active .mobile-group-trigger {
    color: #facc15;
  }

  .mobile-submenu {
    display: none;
    grid-template-columns: 1fr;
    gap: 0.5rem;
  }

  .mobile-group[aria-expanded="true"] .mobile-submenu {
    display: grid;
  }

  .mobile-submenu-link {
    display: block;
    padding: 0.75rem 0.75rem;
    border-radius: 0.75rem;
    text-decoration: none;
    color: rgba(255, 255, 255, 0.92);
    background: rgba(255, 255, 255, 0.04);
    border: var(--border-w) solid rgba(255, 255, 255, 0.14);
    font-weight: 600;
    text-align: center;
    width: 100%;
    font-size: 0.95rem;
    margin-left: 1rem;
    transition: all 150ms ease;
  }

  .mobile-submenu-link:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #facc15;
    border-color: rgba(255, 255, 255, 0.22);
  }

  .mobile-submenu-link.is-active {
    background: rgba(255, 255, 255, 0.08);
    color: #facc15;
    border-color: rgba(255, 255, 255, 0.24);
  }

  @media (min-width: 860px) {
    .nav {
      display: flex;
    }

    .brand-link {
      display: none;
    }

    .menu-toggle {
      display: none;
    }

    .mobile {
      display: none;
    }

    .nav-brandlink {
      display: inline-flex;
    }

    .brand-logo {
      width: 58px;
      height: 58px;
      border-radius: 16px;
    }

    .brand-text {
      font-size: 1.15rem;
    }
  }

  @media (max-width: 859px) {
    .nav-brandlink {
      display: none;
    }
  }

  @keyframes header-shimmer {
    0% {
      background-position: -120% 0;
    }
    100% {
      background-position: 120% 0;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .site-header::before,
    .mobile::after {
      animation: none;
      opacity: 0;
    }
  }
</style>
