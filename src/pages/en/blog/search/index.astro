---
import { getCollection } from "astro:content";
import Layout from "../../../../layouts/Layout.astro";
import Container from "../../../../components/Container.astro";
import PageHeader from "../../../../components/PageHeader.astro";

const posts = await getCollection(
  "blog",
  ({ data }) => !data.draft && data.lang === "en",
);
const searchData = posts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  author: post.data.author,
  date: post.data.pubDatetime.toISOString(),
  tags: post.data.tags || [],
}));

const seo = {
  title: "Search | Blog | STVG",
  description: "Search all blog articles.",
  canonical: "/en/blog/search/",
  lang: "en",
  alternates: [
    { hreflang: "nl", href: "https://www.gayjustice.org/blog/search/" },
    { hreflang: "en", href: "https://www.gayjustice.org/en/blog/search/" },
    { hreflang: "x-default", href: "https://www.gayjustice.org/blog/search/" },
  ],
  breadcrumbs: [
    { name: "GayJustice.org", url: "https://www.gayjustice.org/en/" },
    { name: "Blog", url: "https://www.gayjustice.org/en/blog/" },
    { name: "Search", url: "https://www.gayjustice.org/en/blog/search/" },
  ],
};
---

<Layout seo={seo}>
  <PageHeader eyebrow="Blog" title="Search" lead="Search all articles." />

  <Container>
    <section class="section">
      <div class="surface" style="padding: 22px;">
        <div style="margin-bottom: 24px;">
          <input
            type="search"
            id="search-input"
            placeholder="Search articles..."
            style="width: 100%; padding: 12px 16px; font-size: 1em; border: 1px solid var(--subtle); border-radius: 8px; background: var(--bg); color: var(--text);"
            autofocus
          />
        </div>

        <div id="search-results">
          <p style="text-align: center; color: var(--muted);">
            Type to search...
          </p>
        </div>
      </div>
    </section>

    <nav style="margin-top: 24px;">
      <a href="/en/blog/" class="btn btn-ghost">← Back to blog</a>
    </nav>
  </Container>
</Layout>

<script define:vars={{ searchData }}>
  const input = document.getElementById("search-input");
  const results = document.getElementById("search-results");

  function search(query) {
    if (!query.trim()) {
      results.innerHTML =
        '<p style="text-align: center; color: var(--muted);">Type to search...</p>';
      return;
    }

    const q = query.toLowerCase();
    const matches = searchData.filter(
      (post) =>
        post.title.toLowerCase().includes(q) ||
        post.description.toLowerCase().includes(q) ||
        post.tags.some((tag) => tag.toLowerCase().includes(q)),
    );

    if (matches.length === 0) {
      results.innerHTML =
        '<p style="text-align: center; color: var(--muted);">No results found.</p>';
      return;
    }

    results.innerHTML = `
      <ul style="list-style: none; padding: 0; margin: 0;">
        ${matches
          .map(
            (post) => `
          <li style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--subtle);">
            <h3 style="margin: 0 0 8px;">
              <a href="/en/blog/${post.slug}/" style="color: inherit; text-decoration: none;">${post.title}</a>
            </h3>
            <p style="margin: 4px 0; color: var(--muted); font-size: 0.9em;">
              ${new Date(post.date).toLocaleDateString("en-US")} • ${post.author}
            </p>
            <p style="margin: 8px 0 0;">${post.description}</p>
          </li>
        `,
          )
          .join("")}
      </ul>
    `;
  }

  input.addEventListener("input", (e) => search(e.target.value));

  const urlParams = new URLSearchParams(window.location.search);
  const q = urlParams.get("q");
  if (q) {
    input.value = q;
    search(q);
  }
</script>
