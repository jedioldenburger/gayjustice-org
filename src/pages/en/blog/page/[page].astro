---
import { getCollection } from "astro:content";
import Layout from "../../../../layouts/Layout.astro";
import Container from "../../../../components/Container.astro";
import PageHeader from "../../../../components/PageHeader.astro";

export async function getStaticPaths() {
  const POSTS_PER_PAGE = 10;
  const allPosts = await getCollection(
    "blog",
    ({ data }) => !data.draft && data.lang === "en",
  );
  const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);

  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) },
    props: { postsPerPage: POSTS_PER_PAGE },
  }));
}

const { page } = Astro.params;
const { postsPerPage } = Astro.props;
const POSTS_PER_PAGE = postsPerPage || 10;
const currentPage = parseInt(page);

const allPosts = await getCollection(
  "blog",
  ({ data }) => !data.draft && data.lang === "en",
);
const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDatetime.getTime() - a.data.pubDatetime.getTime(),
);

const totalPages = Math.ceil(sortedPosts.length / POSTS_PER_PAGE);
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const paginatedPosts = sortedPosts.slice(
  startIndex,
  startIndex + POSTS_PER_PAGE,
);

const seo = {
  title: `Blog - Page ${currentPage} | STVG`,
  description: `Blog articles - page ${currentPage} of ${totalPages}.`,
  canonical: `/en/blog/page/${currentPage}/`,
  lang: "en",
  alternates: [
    { hreflang: "nl", href: `https://www.gayjustice.org/blog/` },
    {
      hreflang: "en",
      href: `https://www.gayjustice.org/en/blog/page/${currentPage}/`,
    },
    { hreflang: "x-default", href: `https://www.gayjustice.org/blog/` },
  ],
  breadcrumbs: [
    { name: "GayJustice.org", url: "https://www.gayjustice.org/en/" },
    { name: "Blog", url: "https://www.gayjustice.org/en/blog/" },
    {
      name: `Page ${currentPage}`,
      url: `https://www.gayjustice.org/en/blog/page/${currentPage}/`,
    },
  ],
};
---

<Layout seo={seo}>
  <PageHeader
    eyebrow="Articles"
    title="Blog"
    lead={`Page ${currentPage} of ${totalPages}`}
  />

  <Container>
    <nav
      style="margin-bottom: 24px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center;"
    >
      <a href="/en/blog/search/" class="btn btn-outline">Search</a>
      <a href="/en/blog/tags/" class="btn btn-outline">Tags</a>
      <a href="/rss.xml" class="btn btn-ghost" target="_blank">RSS Feed</a>
    </nav>

    <section class="section">
      <div class="surface" style="padding: 22px;">
        <ul style="list-style: none; padding: 0; margin: 0;">
          {
            paginatedPosts.map((post) => (
              <li style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--subtle);">
                <h3 style="margin: 0 0 8px;">
                  <a
                    href={`/en/blog/${post.slug}/`}
                    style="color: inherit; text-decoration: none;"
                  >
                    {post.data.title}
                  </a>
                </h3>
                <p style="margin: 4px 0; color: var(--muted); font-size: 0.9em;">
                  {post.data.pubDatetime.toLocaleDateString("en-US")} •{" "}
                  {post.data.author}
                </p>
                <p style="margin: 8px 0 0;">{post.data.description}</p>
                {post.data.tags && post.data.tags.length > 0 && (
                  <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                    {post.data.tags.map((tag) => (
                      <a
                        href={`/en/blog/tags/${tag}/`}
                        style="font-size: 0.8em; padding: 2px 8px; background: var(--subtle); border-radius: 4px; text-decoration: none; color: var(--muted);"
                      >
                        {tag}
                      </a>
                    ))}
                  </div>
                )}
              </li>
            ))
          }
        </ul>

        <nav
          style="margin-top: 32px; display: flex; justify-content: center; gap: 8px;"
        >
          <a
            href={currentPage === 2
              ? "/en/blog/"
              : `/en/blog/page/${currentPage - 1}/`}
            class="btn btn-outline"
          >
            ← Previous
          </a>
          <span style="padding: 8px 16px; color: var(--muted);">
            Page {currentPage} of {totalPages}
          </span>
          {
            currentPage < totalPages && (
              <a
                href={`/en/blog/page/${currentPage + 1}/`}
                class="btn btn-outline"
              >
                Next →
              </a>
            )
          }
        </nav>
      </div>
    </section>
  </Container>
</Layout>
